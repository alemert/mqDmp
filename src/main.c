/******************************************************************************/
/*                       D U M P   M Q   O B J E C T S                        */
/*                                                */
/*      module: main               */
/*                                          */
/******************************************************************************/

#define C_MODULE_MAIN_MQDMP

/******************************************************************************/
/*   I N C L U D E S                                                          */
/******************************************************************************/

// ---------------------------------------------------------
// system
// ---------------------------------------------------------
#include <stdio.h>
#include <stdlib.h>
#include <limits.h>

// ---------------------------------------------------------
// MQ
// ---------------------------------------------------------

// ---------------------------------------------------------
// own 
// ---------------------------------------------------------
#include "main.h"
#include <ctl.h>
#include <msgcat/lgstd.h>

// ---------------------------------------------------------
// local
// ---------------------------------------------------------
#include <worker.h>

/******************************************************************************/
/*   D E F I N E S                                                            */
/******************************************************************************/
#define LOG_DIRECTORY   "log"

/******************************************************************************/
/*   M A C R O S                                                              */
/******************************************************************************/

/******************************************************************************/
/*   P R O T O T Y P E S                                                      */
/******************************************************************************/

/******************************************************************************/
/*                                                                            */
/*                                  M A I N                                   */
/*                                                                            */
/******************************************************************************/
#ifndef __TDD__

int main(int argc, const char* argv[] )
{
  int sysRc ;

  // -------------------------------------------------------
  // logging vara
  // -------------------------------------------------------
  char logDir[PATH_MAX];
  char logName[PATH_MAX+NAME_MAX] ;
  int  logLevel = LNA ;


  sysRc = handleCmdLn( argc, argv ) ;
  if( sysRc != 0 ) goto _door ;

  // -------------------------------------------------------
  // setup the logging
  // -------------------------------------------------------
  if( getStrAttr( "log") )
  {
    snprintf( logDir, PATH_MAX, "%s", getStrAttr( "log") ) ;
  }
  else
  {
    snprintf( logDir, PATH_MAX, "%s/%s", getenv("HOME"),LOG_DIRECTORY );
  }

  if( getStrAttr( "loglev" ) )
  {
    logLevel = logStr2lev( getStrAttr( "loglev" ) );
  }

  if( logLevel == LNA )
  {
     logLevel = LOG;
  }

  snprintf( logName, PATH_MAX+NAME_MAX, "%s/%s.log", logDir, progname );
  FILE *fp ;
  fp = fopen( logName, "a+" ) ;
  if( !fp )
  {
    fprintf( stderr, "can not open file %s\n", logName );
    sysRc = 1;
    goto _door;
  }
  fclose(fp);

  sysRc = initLogging( (const char*) logName, logLevel );
  if( sysRc != 0 ) goto _door;

  // -------------------------------------------------------
  // worker: real main
  // -------------------------------------------------------
  sysRc = worker();
  if( sysRc != 0 ) goto _door;

_door :

  return sysRc ;
}

#endif

/******************************************************************************/
/*                                                                            */
/*   F U N C T I O N S                                                        */
/*                                                                            */
/******************************************************************************/

