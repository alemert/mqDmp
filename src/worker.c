/******************************************************************************/
/*                       D U M P   M Q   O B J E C T S                        */
/*                                                                            */
/*      module: worker                                                   */
/*                                                                            */
/*      functions:                              */
/*        - worker                                      */
/*                        */
/******************************************************************************/

/******************************************************************************/
/*   I N C L U D E S                                                          */
/******************************************************************************/

// ---------------------------------------------------------
// system
// ---------------------------------------------------------
//#include <stdio.h>

// ---------------------------------------------------------
// MQ
// ---------------------------------------------------------
#include <cmqc.h>

// ---------------------------------------------------------
// own 
// ---------------------------------------------------------
#include <ctl.h>
#include <mqbase.h>

// ---------------------------------------------------------
// local
// ---------------------------------------------------------
#include "cmdln.h"

#include <worker.h>

/******************************************************************************/
/*   G L O B A L S                                                            */
/******************************************************************************/

/******************************************************************************/
/*   D E F I N E S                                                            */
/******************************************************************************/

/******************************************************************************/
/*   M A C R O S                                                              */
/******************************************************************************/

/******************************************************************************/
/*   P R O T O T Y P E S                                                      */
/******************************************************************************/

/******************************************************************************/
/*                                                                            */
/*   F U N C T I O N S                                                        */
/*                                                                            */
/******************************************************************************/
int worker()
{
  logFuncCall() ;                       

  int sysRc = 0;

  MQHCONN  Hcon   ;                 // connection handle   
  char qmgrName[MQ_Q_MGR_NAME_LENGTH+1] ;
  const char **qmgrAlias ;
  char **p;

  if( getStrAttr( "proxy" ) )
  {
    snprintf( qmgrName, MQ_Q_MGR_NAME_LENGTH, "%s", getStrAttr("proxy"));
  }
  else
  {
    memset(qmgrName,' ', MQ_Q_MGR_NAME_LENGTH );
  }

  // -------------------------------------------------------
  // connect to queue manager
  // -------------------------------------------------------
  sysRc =  mqConn( (char*) qmgrName,      // queue manager          
                           &Hcon  );      // connection handle            
                                          //
  switch( sysRc )                         //
  {                                       //
    case MQRC_NONE :     break ;          // OK
    case MQRC_Q_MGR_NAME_ERROR :          // queue manager does not exists
    {                                     //
      logger(LMQM_UNKNOWN_QMGR,qmgrName); //
      goto _conn;                         //
    }                                     //
    default : goto _conn;                 // error will be logged in mqConn
  }                                       //
                                          //
  // -------------------------------------------------------
  // get remote queue manager aliases
  // -------------------------------------------------------
  qmgrAlias = getQmgrAliases( Hcon, &sysRc ); 

  // -------------------------------------------------------
  // check for command line (show / list queue manager aliases)
  // -------------------------------------------------------
  if( getFlagAttr("show") == 0 )          //
  {                                       //
    p=(char**)qmgrAlias;            //
    while( *p )                      //
    {                                    //
      printf( " %s\n", *p );        //
      p++;                          //
    }                                    //
  }                                       //
                                          //
  // -------------------------------------------------------
  // error handling exit point
  // -------------------------------------------------------
  _door:                                  //
                                          //
  // -------------------------------------------------------
  // connect to queue manager
  // -------------------------------------------------------
  sysRc = mqDisc( &Hcon ) ;               //
                                          //
  switch( sysRc )                         //
  {                                       //
    case MQRC_NONE: break;                //
    default : goto _door ;                //
  }                                       //
                                          //
  logFuncExit( ) ;

  _conn:
  return sysRc ;
}

